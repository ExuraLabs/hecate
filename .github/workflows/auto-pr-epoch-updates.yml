name: Create Epoch Update PR

permissions:
  contents: read
  pull-requests: write

on:
  push:
    branches:
      - automated/epoch-updates

jobs:
  create-pr:
    runs-on: ubuntu-latest
    steps:
      - name: Check out repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check existing PR
        id: check_pr
        run: |
          PRS=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
          "https://api.github.com/repos/${{ github.repository_owner }}/${{ github.repository }}/pulls?state=open&head=automated/epoch-updates")

          if [[ "$PRS" != "[]" ]]; then
            echo "PR already exists, skipping creation..."
            echo "skip_pr=true"  >> "$GITHUB_OUTPUT"
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}


      - name: Extract epoch number from commit
        id: extract-epoch
        run: |
          COMMIT_MSG=$(git log -1 --pretty=%B)
          EPOCH=$(echo "$COMMIT_MSG" | grep -oP "epoch \K\d+")
          echo "EPOCH=$EPOCH" >> $GITHUB_ENV

      - name: Create Pull Request via GitHub CLI
        if: steps.check_pr.outputs.skip_pr
        run: |
          BODY="## ğŸ“Š Automated Epoch Update

          This PR updates epoch boundaries and block data for **Epoch $EPOCH**.

          ### ğŸ” Changes:
          - Updated \`data/epoch_boundaries.csv\`
          - Updated \`data/epoch_blocks.csv\`
          - Updated \`flows/checkpoint.json\`

          Auto-generated by the \`fetch_epoch_data_flow\` run on Prefect."

          gh pr create \
            --title "ğŸ”„ Epoch data update for Epoch $EPOCH" \
            --body "$BODY" \
            --base master \
            --head automated/epoch-updates \
            --label epoch_update
        env:
          EPOCH: ${{ env.EPOCH }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
